<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Game of Life Arcade - Physical Installation</title>

  <style>
    /* ===== LOCAL FONTS (Offline) ===== */
    @font-face {
      font-family: 'Google Sans Flex';
      font-weight: 500;
      font-style: normal;
      font-display: swap;
      src: url('/fonts/GoogleSansFlex-VariableFont_GRAD,ROND,opsz,slnt,wdth,wght.ttf') format('truetype');
    }

    @font-face {
      font-family: 'Google Sans Mono';
      font-weight: 400;
      font-style: normal;
      font-display: swap;
      src: url('/fonts/Google-Sans-Mono-Regular.ttf') format('truetype');
    }

    @font-face {
      font-family: 'Google Sans Mono';
      font-weight: 600;
      font-style: normal;
      font-display: swap;
      src: url('/fonts/Google-Sans-Mono-SemiBold.ttf') format('truetype');
    }

    /* ===== THEME SYSTEM - CSS VARIABLES ===== */
    :root {
      --google-blue: #4285F4;
      --google-red: #EA4335;
      --google-green: #34A853;
      --google-yellow: #FBBC04;
    }

    :root[data-theme="day"] {
      --bg-primary: #FFFFFF;
      --bg-secondary: #F8F9FA;
      --bg-card: #FFFFFF;
      --text-primary: #202124;
      --text-secondary: #7D7D7D;
      --text-tertiary: #5F6368;
      --highlight-blue: var(--google-blue);
      --highlight-red: var(--google-red);
      --highlight-green: var(--google-green);
      --highlight-yellow: var(--google-yellow);
      --border-color: #DADCE0;
      --video-overlay: rgba(255, 255, 255, 0.3);
      /* Code screen inverted: day=dark terminal */
      --code-bg: #33333E;
      --code-text: #E8EAED;
    }

    :root[data-theme="night"] {
      --bg-primary: #1A1A1A;
      --bg-secondary: #2D2D2D;
      --bg-card: #242424;
      --text-primary: #E8EAED;
      --text-secondary: #9AA0A6;
      --text-tertiary: #7B8087;
      --highlight-blue: var(--google-blue);
      --highlight-red: var(--google-red);
      --highlight-green: var(--google-green);
      --highlight-yellow: var(--google-yellow);
      --border-color: #3C4043;
      --video-overlay: rgba(0, 0, 0, 0.5);
      /* Code screen inverted: night=light terminal */
      --code-bg: #FFFFFF;
      --code-text: #202124;
    }

    /* ===== RESET & BASE ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Google Sans Flex', Arial, sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      overflow: hidden;
      width: 100vw;
      height: 100vh;
    }

    /* ===== GLOBAL ANIMATIONS ===== */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }

      to {
        opacity: 0;
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes blink {

      0%,
      50% {
        opacity: 1;
      }

      51%,
      100% {
        opacity: 0;
      }
    }

    /* ===== SCREEN CONTAINER ===== */
    #app-container {
      width: 100%;
      height: 100%;
      position: relative;
      overflow: hidden;
    }
  </style>
</head>

<body>
  <!-- Video Background Layer (Global) -->
  <div id="video-background-layer"
    style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: #000000;">
    <!-- Responsive container for videos (matches screen dimensions) -->
    <div id="video-container"
      style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);">
      <video id="bg-video-idle" src="/videos/idle.mp4" loop muted playsinline
        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; opacity: 0; transition: opacity 0.8s ease;"></video>
      <video id="bg-video-loop" src="/videos/loop.mp4" loop muted playsinline
        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; opacity: 0; transition: opacity 0.8s ease;"></video>
    </div>
  </div>

  <!-- Main app container - screens will be injected here -->
  <div id="app-container"></div>

  <!-- p5.js (Local - Offline) -->
  <script src="/lib/p5.min.js"></script>

  <!-- Main initialization script -->
  <script type="module">
    // ===== IMPORT MANAGERS =====
    import { AppState } from './src/installation/AppState.js'
    import { StorageManager } from './src/installation/StorageManager.js'
    import { InputManager } from './src/installation/InputManager.js'
    import { IframeComm } from './src/installation/IframeComm.js'
    import { ResetManager } from './src/installation/ResetManager.js'
    import { ThemeManager } from './src/installation/ThemeManager.js'
    import { getResponsiveDimensions } from './src/installation/ScreenHelper.js'

    // ===== IMPORT RESET SYSTEM =====
    import { ResetCircleUI } from './src/utils/ResetCircleUI.js'

    // ===== IMPORT SCREENS =====
    import { IdleScreen } from './src/screens/IdleScreen.js'
    import { WelcomeScreen } from './src/screens/WelcomeScreen.js'
    import { GalleryScreen } from './src/screens/GalleryScreen.js'
    import { CodeAnimationScreen } from './src/screens/CodeAnimationScreen.js'
    import { GameScreen } from './src/screens/GameScreen.js'
    import { ScoreEntryScreen } from './src/screens/ScoreEntryScreen.js'
    import { LeaderboardScreen } from './src/screens/LeaderboardScreen.js'
    import { QRCodeScreen } from './src/screens/QRCodeScreen.js'

    console.log('=== GAME OF LIFE ARCADE - Physical Installation ===')
    console.log('Initializing...')

    // ===== INITIALIZE MANAGERS =====
    const appState = new AppState()
    const storageManager = new StorageManager()
    const inputManager = new InputManager()
    const iframeComm = new IframeComm()
    const themeManager = new ThemeManager()

    console.log('✓ Managers initialized')

    // ===== CONNECT THEME MANAGER TO INPUT MANAGER =====
    inputManager.onKeyPress((key, event) => {
      const theme = inputManager.getThemeFromKey(key)
      if (theme) {
        console.log(`Theme change requested: ${theme}`)
        themeManager.setTheme(theme)
      }
    })

    // ===== CONNECT THEME MANAGER TO VIDEO SYSTEM =====
    themeManager.addObserver((theme) => {
      console.log(`Video system: Theme changed to ${theme}`)
      updateVideoSources(theme)
    })

    // Initialize video sources with current theme
    updateVideoSources(themeManager.getTheme())

    // Initialize video container size (responsive)
    updateVideoContainerSize()

    console.log('✓ Theme system connected (keys 1-4: day, 5-8: night)')
    console.log('✓ Video system connected to theme')
    console.log('✓ Video container responsive initialized')

    // ===== INITIALIZE RESET SYSTEM =====
    const resetCircleUI = new ResetCircleUI()
    const resetManager = new ResetManager(inputManager, appState, storageManager, resetCircleUI)
    resetManager.startListening()

    console.log('✓ Reset system initialized (M=3s soft, M+N=10s hard)')

    // ===== CREATE SCREEN INSTANCES =====
    const screens = {
      idle: new IdleScreen(appState, inputManager, storageManager),
      welcome: new WelcomeScreen(appState, inputManager),
      gallery: new GalleryScreen(appState, inputManager),
      code: new CodeAnimationScreen(appState, inputManager),
      game: new GameScreen(appState, inputManager, iframeComm, themeManager),
      score: new ScoreEntryScreen(appState, inputManager, storageManager),
      leaderboard: new LeaderboardScreen(appState, inputManager, storageManager),
      qr: new QRCodeScreen(appState, inputManager)
    }

    console.log('✓ Screen instances created')

    // ===== CURRENT SCREEN TRACKING =====
    let currentScreenName = null

    // ===== VIDEO CONTROL =====

    /**
     * Update video sources based on current theme
     * Day mode: idle.mp4 / loop.mp4
     * Night mode: idle_dark.mp4 / loop_dark.mp4
     */
    function updateVideoSources(theme) {
      const vidIdle = document.getElementById('bg-video-idle')
      const vidLoop = document.getElementById('bg-video-loop')

      if (!vidIdle || !vidLoop) return

      // Determine video filenames based on theme
      const suffix = theme === 'night' ? '_dark' : ''
      const idleSrc = `/videos/idle${suffix}.mp4`
      const loopSrc = `/videos/loop${suffix}.mp4`

      // Only change if different (avoid unnecessary reloads)
      if (vidIdle.src !== window.location.origin + idleSrc) {
        const wasPlaying = !vidIdle.paused
        const currentTime = vidIdle.currentTime

        vidIdle.src = idleSrc
        vidIdle.load()

        // Resume playback if it was playing
        if (wasPlaying) {
          vidIdle.currentTime = currentTime
          vidIdle.play().catch(e => console.log('Idle video play prevented:', e))
        }
      }

      if (vidLoop.src !== window.location.origin + loopSrc) {
        const wasPlaying = !vidLoop.paused
        const currentTime = vidLoop.currentTime

        vidLoop.src = loopSrc
        vidLoop.load()

        // Resume playback if it was playing
        if (wasPlaying) {
          vidLoop.currentTime = currentTime
          vidLoop.play().catch(e => console.log('Loop video play prevented:', e))
        }
      }

      console.log(`Video sources updated for ${theme} mode: ${idleSrc}, ${loopSrc}`)
    }

    /**
     * Update video container size to match screen dimensions (responsive)
     * Applies same logic as screens: portrait 1200×1920 with aspect ratio 10:16
     */
    function updateVideoContainerSize() {
      const { containerWidth, containerHeight } = getResponsiveDimensions()
      const videoContainer = document.getElementById('video-container')

      if (!videoContainer) return

      videoContainer.style.width = `${containerWidth}px`
      videoContainer.style.height = `${containerHeight}px`
      videoContainer.style.maxWidth = '100vw'
      videoContainer.style.maxHeight = '100vh'
      videoContainer.style.aspectRatio = '10 / 16'

      console.log(`Video container updated: ${containerWidth}×${containerHeight}`)
    }

    function updateVideoBackground(screenName) {
      const vidIdle = document.getElementById('bg-video-idle')
      const vidLoop = document.getElementById('bg-video-loop')

      if (!vidIdle || !vidLoop) return

      // Helper to play if paused
      const ensurePlaying = (vid) => {
        if (vid.paused) vid.play().catch(e => console.log('Auto-play prevented:', e))
      }

      // Helper to pause after transition (saves resources)
      const pauseAfterTransition = (vid) => {
        setTimeout(() => {
          // Only pause if it's still hidden (opacity is 0)
          if (vid.style.opacity === '0') {
            vid.pause()
          }
        }, 1000) // Wait for 0.8s transition + buffer
      }

      if (screenName === 'idle' || screenName === 'idle-leaderboard') {
        // Idle Screens: Show idle video
        ensurePlaying(vidIdle)
        vidIdle.style.opacity = '1'

        vidLoop.style.opacity = '0'
        pauseAfterTransition(vidLoop)

      } else if (screenName === 'code' || screenName === 'game') {
        // Code & Game Screens: Hide ALL videos (opaque background)
        vidIdle.style.opacity = '0'
        vidLoop.style.opacity = '0'

        pauseAfterTransition(vidIdle)
        pauseAfterTransition(vidLoop)

      } else {
        // All other screens: Show loop video
        ensurePlaying(vidLoop)
        vidLoop.style.opacity = '1'

        vidIdle.style.opacity = '0'
        pauseAfterTransition(vidIdle)
      }
    }

    // ===== SCREEN TRANSITION HANDLER =====
    function handleScreenChange(newScreenName) {
      console.log(`Screen transition: ${currentScreenName} → ${newScreenName}`)

      // Update video background
      updateVideoBackground(newScreenName)

      // Hide current screen
      if (currentScreenName && screens[currentScreenName]) {
        console.log(`Hiding ${currentScreenName}`)
        screens[currentScreenName].hide()
      }

      // Show new screen
      if (screens[newScreenName]) {
        console.log(`Showing ${newScreenName}`)
        screens[newScreenName].show()
        currentScreenName = newScreenName
      } else {
        console.error(`Screen "${newScreenName}" not found!`)
      }
    }

    // ===== REGISTER APPSTATE OBSERVER =====
    appState.subscribe((state) => {
      console.log('AppState changed:', state)

      // Check if screen changed
      if (state.currentScreen !== currentScreenName) {
        handleScreenChange(state.currentScreen)
      }
    })

    console.log('✓ AppState observer registered')

    // ===== START WITH IDLE SCREEN =====
    console.log('Starting with IdleScreen...')
    handleScreenChange('idle')

    // ===== EXPOSE FOR DEBUGGING (optional) =====
    window.arcade = {
      appState,
      storageManager,
      inputManager,
      iframeComm,
      resetManager,
      resetCircleUI,
      screens
    }

    console.log('✓ Installation ready')
    console.log('Press SPACE to begin')

    // ===== RESIZE LISTENER FOR VIDEO CONTAINER =====
    window.addEventListener('resize', () => {
      updateVideoContainerSize()
    })

    console.log('✓ Resize listener registered for video container')
  </script>
</body>

</html>